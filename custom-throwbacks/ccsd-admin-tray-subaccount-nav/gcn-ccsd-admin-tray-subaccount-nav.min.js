/**
// @name        Admin Tray Sub Account Nav Throwback for Global Custom Navigation
// @namespace   https://github.com/robert-carroll/canvaslms-global-custom-navigation
// @description adds searchable sub accounts to the admin tray
//
**/

const gcn_AdminTraySubAccountNav=function(){const e={search_text:"Search...",reload_text:"This will clear and reload the menu...\n...updating with any recent changes.\nDo you want to continue?",instance:location.host+"_subaccount_tray",tree:[],html:null,searchAccountFilter:[],accountFilter:[],skipRootInSearch:!0,loadingSaveProgressInterval:2e3,dir:document.querySelector("html").getAttribute("dir")??"ltr",init:async t=>{e.accountFilter=t.accountFilter||e.accountFilter,e.searchAccountFilter=t.searchAccountFilter||e.searchAccountFilter,e.skipRootInSearch=t.skipRoot||e.skipRootInSearch;const n=localStorage.getItem(e.instance);if(n){const t=JSON.parse(n);e.tree=t}else e.get_root_accounts()},tree_to_html:function(t,n=[]){var r=`<ul${0==n.length?' id="gcn-admin-tray-san"':""} data-tree="${n.join(":")}" ${n.length?'style="display: none;"':""} class="${e.tray.ul_class}" dir="${e.dir}">`;for(let a in t){let c=t[a];const o=n.join(":")+(n.length?":":"")+a;r+=`<li data-tree="${o}" class="${e.tray.li_class}" dir="${e.dir}">`,r+=c.children&&c.children.length?`<a href="#${o}" class="gcn-san-toggle icon-solid icon-arrow-open-${"ltr"==e.dir?"end":"start"}"></a>`:"",r+=`<a href="/accounts/${c.id}" class="sub-acc" dir="${e.dir}">${c.name}</a>`,r+="</li>"}return r+="</ul>"},render_path_children:function(t){const n=t.target.getAttribute("href").replace("#","").split(":");let r=e.tree;for(let t=0;t<n.length;t++){const c=n[t];r=r.children?r.children[c]:r[c];const o=n.slice(0,t+1);let i=document.querySelector(`li[data-tree="${o.join(":")}"]`);if(null===document.querySelector(`ul[data-tree="${o.join(":")}"]`)){var a=e.tree_to_html(r.children||[],o);i.insertAdjacentHTML("beforeend",a)}}},tree_search:function(t){if(t.length<3)document.querySelector("#gcn-admin-tray-san-results").innerHTML="";else{var n=[],r=t.split(/\s+/).map((e=>new RegExp(e.trim(),"i"))),a=e.searchAccountFilter.map((e=>e instanceof RegExp?e:new RegExp(e.trim(),"i"))),c=(t,o,i=0,l=[])=>{var s=t.name,d=!1;if(r.filter((e=>e.test(s))).length){const e=r.filter((e=>!e.test(s)));d=!e.length||e.every((e=>l.some((t=>e.test(t.name)))))}if(d&&n.push({id:t.id,name:s,parents:l,root:o}),t.children&&t.children.length){let n=l;e.skipRootInSearch&&t.url||a.some((e=>e.test(s)))||(n=l.concat({id:t.id,name:s}));for(let e=0,r=t.children.length;e<r;e++)c(t.children[e],o,i+1,n)}};for(let t in e.tree){const n=e.tree[t];c(n,t)}document.querySelector("#gcn-admin-tray-san-results").innerHTML="";for(let t of n){var o="";for(let n of t.parents)o+=`<a href='/accounts/${n.id}'>${n.name}</a>`,o+=`<span> ${"ltr"==e.dir?"&gt;":"&lt;"} </span>`;o+=`<a href='/accounts/${t.id}'>${t.name}</a>`,document.querySelector("#gcn-admin-tray-san-results").innerHTML+=`<li>${o}</li>`}}},controls:()=>{document.querySelector(`#${e.container_id} #gcn-admin-tray-san`).addEventListener("click",(t=>{if(!t.target.closest(`#${e.container_id} a.gcn-san-toggle`))return;t.preventDefault(),document.querySelector(`#${e.container_id} ul[data-tree="${t.target.getAttribute("href").replace("#","")}"]`)||e.render_path_children(t);let n=document.querySelector(`#${e.container_id} ul[data-tree="${t.target.getAttribute("href").replace("#","")}"]`);var r=t.target.closest(`#${e.container_id} a.gcn-san-toggle`),a="ltr"==e.dir?"end":"start";n.classList.contains("gcn-san-list-open")?(n.classList.remove("gcn-san-list-open"),r.classList.add("icon-arrow-open-"+a),r.classList.remove("icon-arrow-open-down")):(n.classList.add("gcn-san-list-open"),r.classList.add("icon-arrow-open-down"),r.classList.remove("icon-arrow-open-"+a))}));var t=null;document.querySelector("#gcn-admin-tray-san-search").oninput=n=>{var r=n.target.value;null!=t&&clearTimeout(t),t=setTimeout((function(){e.tree_search(r),t=null}),300)},document.querySelector(`#${e.container_id} a.gcn-san-reload`).onclick=t=>{t.preventDefault();let n=e.reload_text;confirm(n)&&(localStorage.removeItem(e.instance),e.tree=[],e.html=null,e.get_root_accounts(),e.throwback(e.tray))}},get_root_accounts:async()=>{let t,n={index:{},ids:[]},r=1;localStorage.removeItem(e.instance);let a=localStorage.getItem(`${e.instance}.tmp`),c=localStorage.getItem(`${e.instance}.root`),o=localStorage.getItem(`${e.instance}.page`);a&&(n=JSON.parse(a),a=null);var i=await fetch("/api/v1/accounts/",{method:"GET",headers:{Accept:"application/json+canvas-string-ids"}}).then((e=>{if(!e.ok)throw Error(e.status);return e.json()})).catch((e=>console.error(e))),l=setInterval((()=>{localStorage.setItem(`${e.instance}.page`,r),localStorage.setItem(`${e.instance}.root`,t),localStorage.setItem(`${e.instance}.tmp`,JSON.stringify(n))}),e.loadingSaveProgressInterval);try{for(let a of i){if(null!==a.root_account_id)continue;if(t=a.id,c){if(c!=t)continue;c==t&&(c=null)}t in n.index||(n.ids.push(t),n.index[t]={id:t,name:a.name,parent_id:a.parent_account_id});let i=!1;for(o?(r=+o,o=null):r=1;!i;){var s=await fetch(`/api/v1/accounts/${t}/sub_accounts?recursive=true&per_page=100&page=${r}`,{method:"GET",headers:{Accept:"application/json+canvas-string-ids"}}).then((e=>{if(!e.ok)throw Error(e.status);return e.json()})).catch((e=>console.error(e)));if(0===s.length){i=!0;break}for(let t=0,r=s.length;t<r;t++){const r=s[t],a=r.id;e.accountFilter.includes(a)||(n.index[a]={id:a,name:r.name,parent_id:r.parent_account_id},n.ids.push(a))}r++}}const a=e.accounts_to_tree(n);clearInterval(l),localStorage.removeItem(`${e.instance}.page`),localStorage.removeItem(`${e.instance}.root`),localStorage.removeItem(`${e.instance}.tmp`),localStorage.setItem(e.instance,JSON.stringify(a))}catch(e){console.error(e),clearInterval(l)}},accounts_to_tree:t=>{const n=[];for(let e=0,r=t.ids.length;e<r;e++){const r=t.ids[e],a=t.index[r];if(a.parent_id){if(!(a.parent_id in t.index))continue;{const e=a.parent_id,n=t.index[e];n.children?n.children.push(a):n.children=[a]}}else n.push(a)}const r=e=>{if(e.children){e.children.length>10&&e.children.sort(((e,t)=>e.name<t.name?-1:1));for(let t of e.children)r(t)}};for(let e in n)r(n[e]);return e.tree=n,e.throwback(e.tray),n},throwback:(t={})=>{e.tray=t||e.tray,e.container_id=("rspv"==e.tray.type?"rspv-":"")+"gcn-admin-tray-subaccount-nav";let n=document.querySelector(`#${e.container_id}`);n&&n.remove();let r="";0!=e.tree.length?(e.html=e.tree_to_html(e.tree),r=`<input type="text" id="gcn-admin-tray-san-search" placeholder="${e.search_text}" />\n <ol id="gcn-admin-tray-san-results" class="${e.tray.ul_class}" dir="${e.dir}"></ol>\n ${e.html}<a href="#" class="gcn-san-reload" dir="${e.dir}"><i class="icon-solid icon-refresh" aria-hidden="true" /></a>`):r='<svg role="img" aria-labelledby="gcn-san-tray-loading_svg" focusable="false" class="gcn_tray_throwback-spinner__circle">\n <title id="gcn-san-tray-loading_svg">Loading</title>\n <g role="presentation">\n <circle cx="50%" cy="50%" r="1em" class="gcn_tray-spinner__circleTrack"></circle>\n <circle cx="50%" cy="50%" r="1em" class="gcn_tray-spinner__circleSpin"></circle>\n </g>\n </svg>';let a=document.createElement("div");a.id=e.container_id,a.dir=e.dir,a.dir=document.querySelector("html").getAttribute("dir")??"ltr",a.innerHTML=`<hr role="presentation">${r}`,e.tray.where.append(a),document.querySelector(e.tray.mark).classList.add(e.tray.complete),e.html&&e.controls()}};return{init:e.init,throwback:e.throwback}}();